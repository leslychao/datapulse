### =========================================================
### AUTH — Keycloak password grant (access_token)
### =========================================================
POST {{keycloakBaseUrl}}/realms/{{keycloakRealm}}/protocol/openid-connect/token
Content-Type: application/x-www-form-urlencoded

grant_type=password&client_id={{keycloakClientId}}&client_secret={{keycloakClientSecret}}&username={{keycloakUsername}}&password={{keycloakPassword}}

> {%
  client.test("Auth — got access_token", function () {
    client.assert(response.status === 200, "expected 200, got " + response.status);

    const b = response.body || {};
    client.assert(!!b.access_token, "missing access_token in response");

    client.global.set("access_token", b.access_token);
  });
%}

### =========================================================
### PREPARE — create account + resolve current user + resolve owner memberId
### =========================================================

### 0.1 ACCOUNT — CREATE (201)
POST {{host}}/api/accounts
Content-Type: application/json
Authorization: Bearer {{access_token}}

{
  "name": "Test Account — Members"
}

> {%
  client.test("Prepare /api/accounts — create 201", function () {
    client.assert(response.status === 201, "expected 201, got " + response.status);

    var b = response.body || {};
    client.assert(b.id !== undefined, "missing id in response");

    client.global.set("accountIdMembers", String(b.id || ""));
  });
%}

### 0.2 IAM — GET current user profile (200) -> currentUserId
GET {{host}}/api/iam
Authorization: Bearer {{access_token}}

> {%
  client.test("Prepare /api/iam — get current user 200", function () {
    client.assert(response.status === 200, "expected 200, got " + response.status);

    var b = response.body || {};
    client.assert(b.id !== undefined, "missing id in response");

    client.global.set("currentUserId", String(b.id || ""));
  });
%}

### 0.3 MEMBERS — LIST (200) -> resolve currentAccountMemberId (owner)
GET {{host}}/api/accounts/{{accountIdMembers}}/members
Authorization: Bearer {{access_token}}

> {%
  client.test("Prepare /members — resolve current user's memberId 200", function () {
    client.assert(response.status === 200, "expected 200, got " + response.status);

    var b = response.body;
    client.assert(Array.isArray(b), "expected array response");

    var currentUserId = String(client.global.get("currentUserId"));
    var found = null;

    for (var i = 0; i < b.length; i++) {
      var m = b[i] || {};
      if (String(m.userId) === currentUserId) {
        found = m;
        break;
      }
    }

    client.assert(found && found.id !== undefined, "current user's member not found in list");
    client.global.set("currentAccountMemberId", String(found.id || ""));
  });
%}

### =========================================================
### TESTS — AccountMemberController /api/accounts/{accountId}/members
### =========================================================

### 1.1 CREATE (NEGATIVE): duplicate (accountId,userId) -> 400
POST {{host}}/api/accounts/{{accountIdMembers}}/members
Content-Type: application/json
Authorization: Bearer {{access_token}}

{
  "userId": {{currentUserId}},
  "role": "ADMIN",
  "status": "ACTIVE"
}

> {%
  client.test("AccountMember /create — duplicate member 400", function () {
    client.assert(response.status === 400, "expected 400, got " + response.status);

    var msg = (response.body && response.body.message) || "";
    client.assert(/уже\s+является\s+участником\s+аккаунта/i.test(msg),
        "unexpected message: " + msg);
  });
%}

### 1.2 UPDATE (NEGATIVE): forbid downgrade last ACTIVE OWNER -> 400 ACCOUNT_MEMBER_LAST_OWNER_FORBIDDEN
PUT {{host}}/api/accounts/{{accountIdMembers}}/members/{{currentAccountMemberId}}
Content-Type: application/json
Authorization: Bearer {{access_token}}

{
  "role": "ADMIN",
  "status": "ACTIVE"
}

> {%
  client.test("AccountMember /update — forbid downgrade last ACTIVE OWNER 400", function () {
    client.assert(response.status === 400, "expected 400, got " + response.status);

    var b = response.body || {};
    var msg = (b && b.message) || (b && b.error) || "";
    client.assert(/last\s+owner|последн.*владел|ACCOUNT_MEMBER_LAST_OWNER_FORBIDDEN/i.test(msg),
        "no last-owner-forbidden hint: " + msg);
  });
%}

### 1.3 UPDATE (NEGATIVE): forbid deactivate last ACTIVE OWNER -> 400 ACCOUNT_MEMBER_LAST_OWNER_FORBIDDEN
PUT {{host}}/api/accounts/{{accountIdMembers}}/members/{{currentAccountMemberId}}
Content-Type: application/json
Authorization: Bearer {{access_token}}

{
  "role": "OWNER",
  "status": "INACTIVE"
}

> {%
  client.test("AccountMember /update — forbid deactivate last ACTIVE OWNER 400", function () {
    client.assert(response.status === 400, "expected 400, got " + response.status);

    var b = response.body || {};
    var msg = (b && b.message) || (b && b.error) || "";
    client.assert(/last\s+owner|последн.*владел|ACCOUNT_MEMBER_LAST_OWNER_FORBIDDEN/i.test(msg),
        "no last-owner-forbidden hint: " + msg);
  });
%}

### 1.4 DELETE (NEGATIVE): forbid delete last ACTIVE OWNER -> 400 ACCOUNT_MEMBER_LAST_OWNER_FORBIDDEN
DELETE {{host}}/api/accounts/{{accountIdMembers}}/members/{{currentAccountMemberId}}
Authorization: Bearer {{access_token}}

> {%
  client.test("AccountMember /delete — forbid delete last ACTIVE OWNER 400", function () {
    client.assert(response.status === 400, "expected 400, got " + response.status);

    var b = response.body || {};
    var msg = (b && b.message) || (b && b.error) || "";
    client.assert(/last\s+owner|последн.*владел|ACCOUNT_MEMBER_LAST_OWNER_FORBIDDEN/i.test(msg),
        "no last-owner-forbidden hint: " + msg);
  });
%}

### 1.5 UPDATE (NEGATIVE): not found -> 404
PUT {{host}}/api/accounts/{{accountIdMembers}}/members/9999999
Content-Type: application/json
Authorization: Bearer {{access_token}}

{
  "role": "VIEWER",
  "status": "ACTIVE"
}

> {%
  client.test("AccountMember /update — not found 404", function () {
    client.assert(response.status === 404, "expected 404, got " + response.status);

    var b = response.body || {};
    var msg = (b && b.message) || (b && b.error) || "";
    client.assert(/не\s*найден|not\s*found/i.test(msg), "no 'not found' hint: " + msg);
  });
%}

### 1.6 DELETE (NEGATIVE): not found -> 404
DELETE {{host}}/api/accounts/{{accountIdMembers}}/members/9999999
Authorization: Bearer {{access_token}}

> {%
  client.test("AccountMember /delete — not found 404", function () {
    client.assert(response.status === 404, "expected 404, got " + response.status);

    var b = response.body || {};
    var msg = (b && b.message) || (b && b.error) || "";
    client.assert(/не\s*найден|not\s*found/i.test(msg), "no 'not found' hint: " + msg);
  });
%}

### =========================================================
### CLEANUP — delete account (CASCADE deletes members)
### =========================================================

### 2.1 DELETE ACCOUNT (204)
DELETE {{host}}/api/accounts/{{accountIdMembers}}
Authorization: Bearer {{access_token}}

> {%
  client.test("Cleanup — delete account 204", function () {
    client.assert(response.status === 204, "expected 204, got " + response.status);
  });
%}
