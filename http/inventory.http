### =========================================================
### 1. INVENTORY-SNAPSHOT API — базовые сценарии выборки
### =========================================================

### 1.0 ТЕСТОВЫЕ ПЕРЕМЕННЫЕ
# {{host}} — задан в environment
# {{accountId}} — id тестового аккаунта
# {{snapshotDate}} — дата (YYYY-MM-DD), по которой точно есть данные
#
# Пример:
#   {{accountId}} = 1
#   {{snapshotDate}} = 2025-12-26

### 1.1 INVENTORY-SNAPSHOT — базовая выборка по accountId (path) + marketplace (200)
GET {{host}}/api/accounts/{{accountId}}/inventory-snapshots?marketplace=OZON&page=0&size=20&
    sort=snapshotDate,desc

> {%
  client.test("InventorySnapshot /list — base by accountId(path)+marketplace 200", function () {
    client.assert(response.status === 200, "expected 200, got " + response.status);

    var b = response.body || {};
    client.assert(Array.isArray(b.content), "content is not an array");
    client.assert(typeof b.totalElements === "number", "totalElements is not a number");
    client.assert(typeof b.totalPages === "number", "totalPages is not a number");
  });
%}

### 1.2 INVENTORY-SNAPSHOT — выборка с явным диапазоном дат (200)
GET {{host}}/api/accounts/{{accountId}}/inventory-snapshots?marketplace=OZON&
    fromDate={{snapshotDate}}&toDate={{snapshotDate}}&page=0&size=50

> {%
  client.test("InventorySnapshot /list — filter by date range 200", function () {
    client.assert(response.status === 200, "expected 200, got " + response.status);

    var b = response.body || {};
    client.assert(Array.isArray(b.content), "content is not an array");
    client.assert(typeof b.totalElements === "number", "totalElements is not a number");
  });
%}

### 1.3 INVENTORY-SNAPSHOT — пагинация: вторая страница (200)
GET {{host}}/api/accounts/{{accountId}}/inventory-snapshots?marketplace=OZON&
    fromDate={{snapshotDate}}&toDate={{snapshotDate}}&page=1&size=10&sort=snapshotDate,desc

> {%
  client.test("InventorySnapshot /list — page=1 size=10 200", function () {
    client.assert(response.status === 200, "expected 200, got " + response.status);

    var b = response.body || {};
    client.assert(Array.isArray(b.content), "content is not an array");

    if (typeof b.size === "number") {
      client.assert(b.size === 10, "page size is not 10 (actual: " + b.size + ")");
    }

    if (b.number !== undefined) {
      client.assert(b.number === 1, "page number is not 1 (actual: " + b.number + ")");
    }
  });
%}

### =========================================================
### 2. INVENTORY-SNAPSHOT API — негативные валидации
### =========================================================

### 2.1 INVENTORY-SNAPSHOT — NEGATIVE: некорректный accountId (не число) → 400
# Scenario: path variable accountId не парсится в Long.
GET {{host}}/api/accounts/abc/inventory-snapshots?marketplace=OZON&page=0&size=20

> {%
  client.test("InventorySnapshot /list — invalid accountId type 400", function () {
    client.assert(response.status === 400, "expected 400, got " + response.status);

    var b = response.body || {};
    var msg =
        (b && b.message) ||
        (b && b.error) ||
        (Array.isArray(b.errors) && b.errors[0] && (b.errors[0].message || b.errors[0])) ||
        "";

    client.assert(/accountId|Long|type|типа|несоответ/i.test(msg),
        "no accountId type-mismatch hint: " + msg);
  });
%}

### 2.2 INVENTORY-SNAPSHOT — marketplace не передан → 200 (marketplace optional)
GET {{host}}/api/accounts/{{accountId}}/inventory-snapshots?page=0&size=20

> {%
  client.test("InventorySnapshot /list — missing marketplace returns 200", function () {
    client.assert(response.status === 200, "expected 200, got " + response.status);

    var b = response.body || {};
    client.assert(Array.isArray(b.content), "content is not an array");
    client.assert(typeof b.totalElements === "number", "totalElements is not a number");
    client.assert(typeof b.totalPages === "number", "totalPages is not a number");
  });
%}

### 2.3 INVENTORY-SNAPSHOT — NEGATIVE: fromDate > toDate → 400
# Scenario: некорректный диапазон дат (fromDate позже toDate).
GET {{host}}/api/accounts/{{accountId}}/inventory-snapshots?marketplace=OZON&fromDate=2099-12-31&
    toDate=2000-01-01&page=0&size=20

> {%
  client.test("InventorySnapshot /list — invalid date range 400", function () {
    client.assert(response.status === 400, "expected 400, got " + response.status);

    var b = response.body || {};
    var msg =
        (b && b.message) ||
        (b && b.error) ||
        "";

    client.assert(typeof msg === "string" && msg.length > 0,
        "no error message for invalid date range");
  });
%}

### 2.4 INVENTORY-SNAPSHOT — NEGATIVE: неверное значение enum marketplace → 400
GET {{host}}/api/accounts/{{accountId}}/inventory-snapshots?marketplace=UNKNOWN_MP&page=0&size=20

> {%
  client.test("InventorySnapshot /list — invalid marketplace enum 400", function () {
    client.assert(response.status === 400, "expected 400, got " + response.status);

    var b = response.body || {};
    var msg =
        (b && b.message) ||
        (b && b.error) ||
        (Array.isArray(b.errors) && b.errors[0] && (b.errors[0].message || b.errors[0])) ||
        "";

    client.assert(/marketplace|enum|перечислен/i.test(msg),
        "no enum validation hint: " + msg);
  });
%}

### 2.5 INVENTORY-SNAPSHOT — NEGATIVE: некорректные параметры пагинации → 200 (фактическое поведение)
GET {{host}}/api/accounts/{{accountId}}/inventory-snapshots?marketplace=OZON&page=-1&size=0

> {%
  client.test("InventorySnapshot /list — invalid pagination params normalized 200", function () {
    client.assert(response.status === 200, "expected 200, got " + response.status);

    var b = response.body || {};
    client.assert(Array.isArray(b.content), "content is not an array");
  });
%}
