### =========================================================
### 0. AUTH — Keycloak password grant (получить access_token)
### =========================================================
POST {{keycloakBaseUrl}}/realms/{{keycloakRealm}}/protocol/openid-connect/token
Content-Type: application/x-www-form-urlencoded

grant_type=password&client_id={{keycloakClientId}}&client_secret={{keycloakClientSecret}}&username={{keycloakUsername}}&password={{keycloakPassword}}

> {%
  client.test("Auth — got access_token", function () {
    client.assert(response.status === 200, "expected 200, got " + response.status);

    const b = response.body || {};
    client.assert(!!b.access_token, "missing access_token in response");

    client.global.set("access_token", b.access_token);
  });
%}

### =========================================================
### 1. ACCOUNT API — базовый жизненный цикл и валидации
### =========================================================

### 1.1 ACCOUNT — CREATE (201)
# Scenario: успешное создание аккаунта с минимально необходимыми данными.
POST {{host}}/api/accounts
Content-Type: application/json
Authorization: Bearer {{access_token}}

{
  "name": "Test Account"
}

> {%
  client.test("Account /create — success 201", function () {
    client.assert(response.status === 201, "expected 201, got " + response.status);

    var b = response.body || {};
    client.assert(b.id !== undefined, "missing id in response");
    client.assert(typeof b.name === "string" && b.name.length > 0, "invalid name in response");

    // Сохраняем id аккаунта для последующих тестов.
    client.global.set("accountId", String(b.id || ""));
  });
%}

### 1.2 ACCOUNT — UPDATE (200)
# Scenario: успешное изменение имени существующего аккаунта.
PUT {{host}}/api/accounts/{{accountId}}
Content-Type: application/json
Authorization: Bearer {{access_token}}

{
  "name": "Test Account — updated"
}

> {%
  client.test("Account /update — success 200", function () {
    client.assert(response.status === 200, "expected 200, got " + response.status);

    var b = response.body || {};
    client.assert(String(b.id) === String(client.global.get("accountId")), "id mismatch after update");
    client.assert(/updated/i.test(b.name), "name was not updated");
  });
%}

### 1.3 ACCOUNT — UPDATE: same name different case (200)
# Scenario: обновление имени тем же значением в другом регистре,
#           должно проходить без конфликта уникальности.
PUT {{host}}/api/accounts/{{accountId}}
Content-Type: application/json
Authorization: Bearer {{access_token}}

{
  "name": "TEST ACCOUNT — UPDATED"
}

> {%
  client.test("Account /update — same-name-different-case 200", function () {
    client.assert(response.status === 200, "expected 200, got " + response.status);

    var b = response.body || {};
    client.assert(/UPDATED/i.test(b.name), "name with different case was not applied");
  });
%}

### 1.4 ACCOUNT — NEGATIVE: blank name → 400
# Scenario: попытка создать аккаунт с пустым именем — должна вернуть 400 и
#           человекочитаемую подсказку про обязательность/пустоту name.
POST {{host}}/api/accounts
Content-Type: application/json
Authorization: Bearer {{access_token}}

{
  "name": " "
}

> {%
  client.test("Account /create — blank name 400", function () {
    client.assert(response.status === 400, "expected 400, got " + response.status);

    var b = response.body || {};
    var msg =
        (b && b.message) ||
        (b && b.error) ||
        (Array.isArray(b.errors) && b.errors[0] && (b.errors[0].message || b.errors[0])) ||
        "";

    client.assert(/name|обязательно|пуст/i.test(msg), "no validation hint for blank name: " + msg);
  });
%}

### 1.5 ACCOUNT — NEGATIVE: name > 32 → 400
# Scenario: попытка создать аккаунт с именем длиннее бизнес-ограничения
#           (например, 32 символа) — должна вернуть 400 и подсказку про длину.
POST {{host}}/api/accounts
Content-Type: application/json
Authorization: Bearer {{access_token}}

{
  "name": "xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx"
}

> {%
  client.test("Account /create — long name 400", function () {
    client.assert(response.status === 400, "expected 400, got " + response.status);

    var b = response.body || {};
    var msg =
        (b && b.message) ||
        (b && b.error) ||
        (Array.isArray(b.errors) && b.errors[0] && (b.errors[0].message || b.errors[0])) ||
        "";

    client.assert(/длина|max/i.test(msg), "no length constraint hint: " + msg);
  });
%}

### 1.6 ACCOUNT — NEGATIVE: not found → 404
# Scenario: попытка обновления несуществующего аккаунта — 404 и сообщение
#           в духе "аккаунт не найден".
PUT {{host}}/api/accounts/9999999
Content-Type: application/json
Authorization: Bearer {{access_token}}

{
  "name": "Not found"
}

> {%
  client.test("Account /update — not found 404", function () {
    client.assert(response.status === 404, "expected 404, got " + response.status);

    var b = response.body || {};
    var msg =
        (b && b.message) ||
        (b && b.error) ||
        (Array.isArray(b.errors) && b.errors[0] && (b.errors[0].message || b.errors[0])) ||
        "";

    client.assert(/не\sнайден/i.test(msg), "no 'not found' hint: " + msg);
  });
%}

### 1.7 ACCOUNT — NEGATIVE: path id ≠ body id → 4xx
# Scenario: защита от рассинхрона id между URL и телом запроса — должен быть
#           любой 4xx (обычно 400).
PUT {{host}}/api/accounts/123456
Content-Type: application/json
Authorization: Bearer {{access_token}}

{
  "id": 654321,
  "name": "Mismatch"
}

> {%
  client.test("Account /update — id mismatch 4xx", function () {
    client.assert(String(response.status).startsWith("4"), "expected 4xx, got " + response.status);
  });
%}

### 1.8 ACCOUNT — NEGATIVE: delete not found → 404
# Scenario: попытка удалить несуществующий аккаунт — 404 с подсказкой,
#           что сущность не найдена.
DELETE {{host}}/api/accounts/9999999
Authorization: Bearer {{access_token}}

> {%
  client.test("Account /delete — not found 404", function () {
    client.assert(response.status === 404, "expected 404, got " + response.status);

    var b = response.body || {};
    var msg =
        (b && b.message) ||
        (b && b.error) ||
        (Array.isArray(b.errors) && b.errors[0] && (b.errors[0].message || b.errors[0])) ||
        "";

    client.assert(/не\sнайден/i.test(msg), "no 'not found' hint on delete: " + msg);
  });
%}

### =========================================================
### 2. ACCOUNT-CONNECTION API — WB/OZON сценарии (PATH: /api/accounts/{accountId}/connections)
### =========================================================

### 2.0 ACCOUNT-CONNECTION — LIST (200) (optional sanity)
GET {{host}}/api/accounts/{{accountId}}/connections
Authorization: Bearer {{access_token}}

> {%
  client.test("AccountConnection /list — 200", function () {
    client.assert(response.status === 200, "expected 200, got " + response.status);
    client.assert(Array.isArray(response.body), "expected array response");
  });
%}

### 2.1 ACCOUNT-CONNECTION — CREATE (WB) → 201
POST {{host}}/api/accounts/{{accountId}}/connections
Content-Type: application/json
Authorization: Bearer {{access_token}}

{
  "marketplace": "WILDBERRIES",
  "credentials": { "token": "xxx" },
  "active": true
}

> {%
  client.test("AccountConnection /create — WB 201", function () {
    client.assert(response.status === 201, "expected 201, got " + response.status);

    var b = response.body || {};
    client.assert(!!b.id, "missing id in response");

    client.global.set("connectionIdWb", String(b.id || ""));
    client.assert(b.marketplace === "WILDBERRIES", "wrong marketplace in response");
    client.assert(b.active === true, "active flag is not true");
  });
%}

### 2.2 ACCOUNT-CONNECTION — CREATE (OZON) → 201
POST {{host}}/api/accounts/{{accountId}}/connections
Content-Type: application/json
Authorization: Bearer {{access_token}}

{
  "marketplace": "OZON",
  "credentials": {
    "clientId": "xxx",
    "apiKey": "yyy"
  },
  "active": true
}

> {%
  client.test("AccountConnection /create — OZON 201", function () {
    client.assert(response.status === 201, "expected 201, got " + response.status);

    var b = response.body || {};
    client.assert(!!b.id, "missing id in response");

    client.global.set("connectionIdOzon", String(b.id || ""));
    client.assert(b.marketplace === "OZON", "wrong marketplace in response");
    client.assert(b.active === true, "active flag is not true");
  });
%}

### 2.3 ACCOUNT-CONNECTION — NEGATIVE: create duplicate OZON for same account → 400
POST {{host}}/api/accounts/{{accountId}}/connections
Content-Type: application/json
Authorization: Bearer {{access_token}}

{
  "marketplace": "OZON",
  "credentials": { "clientId": "dup", "apiKey": "dup" },
  "active": true
}

> {%
  client.test("AccountConnection /create — duplicate OZON 400", function () {
    client.assert(response.status === 400, "expected 400, got " + response.status);

    var b = response.body || {};
    var msg = (b && b.message) || (b && b.error) || "";
    client.assert(/существует|exists|duplicate/i.test(msg), "no duplicate-connection hint: " + msg);
  });
%}

### 2.4 ACCOUNT-CONNECTION — NEGATIVE: create duplicate WB for same account → 400
POST {{host}}/api/accounts/{{accountId}}/connections
Content-Type: application/json
Authorization: Bearer {{access_token}}

{
  "marketplace": "WILDBERRIES",
  "credentials": { "token": "dup" },
  "active": true
}

> {%
  client.test("AccountConnection /create — duplicate WB 400", function () {
    client.assert(response.status === 400, "expected 400, got " + response.status);

    var b = response.body || {};
    var msg = (b && b.message) || (b && b.error) || "";
    client.assert(/существует|exists|duplicate/i.test(msg), "no duplicate-connection hint: " + msg);
  });
%}

### 2.5 ACCOUNT-CONNECTION — UPDATE (OZON) toggle active → 200
PUT {{host}}/api/accounts/{{accountId}}/connections/{{connectionIdOzon}}
Content-Type: application/json
Authorization: Bearer {{access_token}}

{
  "active": false
}

> {%
  client.test("AccountConnection /update — OZON active=false 200", function () {
    client.assert(response.status === 200, "expected 200, got " + response.status);

    var b = response.body || {};
    client.assert(b.marketplace === "OZON", "marketplace changed unexpectedly");
    client.assert(b.active === false, "active flag is not false");
  });
%}

### 2.6 ACCOUNT-CONNECTION — UPDATE (WB) change token → 200 (optional, but useful)
PUT {{host}}/api/accounts/{{accountId}}/connections/{{connectionIdWb}}
Content-Type: application/json
Authorization: Bearer {{access_token}}

{
  "marketplace": "WILDBERRIES",
  "credentials": { "token": "wbtoken-updated" },
  "active": true
}

> {%
  client.test("AccountConnection /update — WB token updated 200", function () {
    client.assert(response.status === 200, "expected 200, got " + response.status);

    var b = response.body || {};
    client.assert(b.marketplace === "WILDBERRIES", "marketplace changed unexpectedly");
    client.assert(b.active === true, "active flag is not true");
  });
%}


### =========================================================
### 4. CLEANUP — удаляем всё созданное в тестах (PATH)
### =========================================================

### 4.1 CLEANUP — DELETE OZON
DELETE {{host}}/api/accounts/{{accountId}}/connections/{{connectionIdOzon}}
Authorization: Bearer {{access_token}}

> {%
  client.test("Cleanup — delete OZON 204", function () {
    client.assert(response.status === 204, "expected 204, got " + response.status);
  });
%}

### 4.2 CLEANUP — DELETE WB
DELETE {{host}}/api/accounts/{{accountId}}/connections/{{connectionIdWb}}
Authorization: Bearer {{access_token}}

> {%
  client.test("Cleanup — delete WB 204", function () {
    client.assert(response.status === 204, "expected 204, got " + response.status);
  });
%}

### 4.3 CLEANUP — DELETE ACCOUNT
DELETE {{host}}/api/accounts/{{accountId}}
Authorization: Bearer {{access_token}}

> {%
  client.test("Cleanup — delete account 204", function () {
    client.assert(response.status === 204, "expected 204, got " + response.status);
  });
%}
