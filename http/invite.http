### =========================================================
### AUTH — Keycloak password grant (access_token)
### =========================================================
POST {{keycloakBaseUrl}}/realms/{{keycloakRealm}}/protocol/openid-connect/token
Content-Type: application/x-www-form-urlencoded

grant_type=password&client_id={{keycloakClientId}}&client_secret={{keycloakClientSecret}}&username={{keycloakUsername}}&password={{keycloakPassword}}

> {%
  client.test("Auth — got access_token", function () {
    client.assert(response.status === 200, "expected 200, got " + response.status);

    const b = response.body || {};
    client.assert(!!b.access_token, "missing access_token in response");
    client.global.set("access_token", b.access_token);
  });
%}

### =========================================================
### PREPARE — create accounts for invites (targets)
### =========================================================

### 0.1 ACCOUNT — CREATE Invite A (201)
POST {{host}}/api/accounts
Content-Type: application/json
Authorization: Bearer {{access_token}}

{
  "name": "Test Account — Invite A"
}

> {%
  client.test("Prepare account A — create 201", function () {
    client.assert(response.status === 201, "expected 201, got " + response.status);

    const b = response.body || {};
    client.assert(b.id !== undefined, "missing id in response");
    client.global.set("accountIdInviteA", String(b.id || ""));
  });
%}

### 0.2 ACCOUNT — CREATE Invite B (201)
POST {{host}}/api/accounts
Content-Type: application/json
Authorization: Bearer {{access_token}}

{
  "name": "Test Account — Invite B"
}

> {%
  client.test("Prepare account B — create 201", function () {
    client.assert(response.status === 201, "expected 201, got " + response.status);

    const b = response.body || {};
    client.assert(b.id !== undefined, "missing id in response");
    client.global.set("accountIdInviteB", String(b.id || ""));
  });
%}

### =========================================================
### (OPTIONAL) PREPARE — create connections (if you want invite tests to cover presence of connections)
### NOTE: Invites API itself не зависит от connections.
###       Оставляю как опциональный sanity, чтобы тесты жили в одном стиле.
### =========================================================

### 0.3 ACCOUNT-CONNECTION — CREATE (WB) for Account A → 201 (optional)
POST {{host}}/api/accounts/{{accountIdInviteA}}/connections
Content-Type: application/json
Authorization: Bearer {{access_token}}

{
  "marketplace": "WILDBERRIES",
  "credentials": { "token": "xxx" }
}

> {%
  client.test("Prepare connection WB (Account A) — 201", function () {
    client.assert([201, 400].indexOf(response.status) >= 0, "unexpected status: " + response.status);

    // Если тесты гоняются на “грязном” стенде, 400 может быть из-за дубля.
    // В чистом окружении ожидаем 201.
    if (response.status === 201) {
      const b = response.body || {};
      client.assert(b.id !== undefined, "missing id in response");
      client.global.set("connectionIdInviteA_Wb", String(b.id || ""));
      client.assert(b.marketplace === "WILDBERRIES", "wrong marketplace in response");
    }
  });
%}

### 0.4 ACCOUNT-CONNECTION — CREATE (OZON) for Account B → 201 (optional)
POST {{host}}/api/accounts/{{accountIdInviteB}}/connections
Content-Type: application/json
Authorization: Bearer {{access_token}}

{
  "marketplace": "OZON",
  "credentials": { "clientId": "xxx", "apiKey": "yyy" }
}

> {%
  client.test("Prepare connection OZON (Account B) — 201", function () {
    client.assert([201, 400].indexOf(response.status) >= 0, "unexpected status: " + response.status);

    if (response.status === 201) {
      const b = response.body || {};
      client.assert(b.id !== undefined, "missing id in response");
      client.global.set("connectionIdInviteB_Ozon", String(b.id || ""));
      client.assert(b.marketplace === "OZON", "wrong marketplace in response");
    }
  });
%}

### =========================================================
### TESTS — AccountInviteController /api/invites
### =========================================================

### 1.0 CREATE (NEGATIVE): email invalid -> 400 (validation)
POST {{host}}/api/invites
Content-Type: application/json
Authorization: Bearer {{access_token}}

{
  "email": "not-an-email",
  "initialRole": "VIEWER",
  "accountIds": [{{accountIdInviteA}}]
}

> {%
  client.test("Invites /create — invalid email 400", function () {
    client.assert(response.status === 400, "expected 400, got " + response.status);

    const b = response.body || {};
    const msg = (b && b.message) || (b && b.error) || JSON.stringify(b);
    client.assert(/email|почт|INVITE_EMAIL/i.test(msg), "unexpected validation response: " + msg);
  });
%}

### 1.1 CREATE (NEGATIVE): accountIds empty -> 400 (validation)
POST {{host}}/api/invites
Content-Type: application/json
Authorization: Bearer {{access_token}}

{
  "email": "invitee@example.com",
  "initialRole": "VIEWER",
  "accountIds": []
}

> {%
  client.test("Invites /create — accountIds empty 400", function () {
    client.assert(response.status === 400, "expected 400, got " + response.status);

    const b = response.body || {};
    const msg = (b && b.message) || (b && b.error) || JSON.stringify(b);

    client.assert(
        /accountIds|accounts|required|INVITE_ACCOUNTS|кабинет|кабинетов|список|пуст/i.test(msg),
        "unexpected validation response: " + msg
    );
  });
%}

### 1.2 CREATE (NEGATIVE): token missing on accept -> 400 (validation)
POST {{host}}/api/invites/accept
Content-Type: application/json
Authorization: Bearer {{access_token}}

{
  "token": ""
}

> {%
  client.test("Invites /accept — empty token 400", function () {
    client.assert(response.status === 400, "expected 400, got " + response.status);

    const b = response.body || {};
    const msg = (b && b.message) || (b && b.error) || JSON.stringify(b);

    client.assert(
        /token|required|INVITE_TOKEN|токен|приглашен|обязател/i.test(msg),
        "unexpected validation response: " + msg
    );
  });
%}

### 1.3 RESOLVE (NEGATIVE): invalid token -> 200 with state INVALID/EXPIRED/...
GET {{host}}/api/invites/resolve?token=invalid-token-value

> {%
  client.test("Invites /resolve — invalid token -> state != PENDING", function () {
    client.assert(response.status === 200, "expected 200, got " + response.status);

    const b = response.body || {};
    client.assert(!!b.state, "missing state in response");

    client.assert(
        /INVALID|EXPIRED|CANCELLED|ALREADY_ACCEPTED|ANONYMOUS_NEED_AUTH|AUTHENTICATED_EMAIL_MISMATCH|AUTHENTICATED_ALREADY_MEMBER/i.test(String(b.state)),
        "unexpected state for invalid token: " + String(b.state)
    );
  });
%}

### 1.4 CREATE (POSITIVE): create invite -> 201 (targets = accounts created in PREPARE)
POST {{host}}/api/invites
Content-Type: application/json
Authorization: Bearer {{access_token}}

{
  "email": "invitee@example.com",
  "initialRole": "VIEWER",
  "accountIds": [{{accountIdInviteA}}, {{accountIdInviteB}}]
}

> {%
  client.test("Invites /create — 201 + store token (best-effort)", function () {
    client.assert(response.status === 201, "expected 201, got " + response.status);

    const b = response.body || {};

    // В OpenAPI AccountInviteResponse нет поля token.
    // Если в вашей реализации токен всё же возвращается — извлечём его.
    const token =
        (b && b.token) ||
        (b && b.inviteToken) ||
        (b && b.invite && b.invite.token) ||
        null;

    if (token) {
      client.global.set("inviteToken", String(token));
    } else {
      // Чтобы тест не падал на стендах, где токен НЕ отдается в ответе:
      // можно (а) отключить следующие шаги, или (б) получать токен из email/логов/БД.
      // Здесь оставляем явный маркер.
      client.global.set("inviteToken", "");
    }

    // Минимальная контрактная проверка по OpenAPI
    client.assert(b.inviteId !== undefined, "missing inviteId in response");
    client.assert(!!b.status, "missing status in response");
    client.assert(Array.isArray(b.targets), "missing targets array in response");
  });
%}

### 1.5 RESOLVE (POSITIVE): if token is known — resolve anonymous (no Authorization)
GET {{host}}/api/invites/resolve?token={{inviteToken}}

> {%
  client.test("Invites /resolve — anonymous resolve 200 (best-effort if token present)", function () {
    const token = String(client.global.get("inviteToken") || "");
    if (!token) {
      client.assert(true, "skipped: inviteToken is not available from create response");
      return;
    }

    client.assert(response.status === 200, "expected 200, got " + response.status);

    const b = response.body || {};
    client.assert(!!b.state, "missing state in response");
    client.assert(/PENDING|ANONYMOUS_NEED_AUTH/i.test(String(b.state)), "unexpected state: " + String(b.state));
  });
%}

### 1.6 RESOLVE (POSITIVE): if token is known — resolve authenticated
GET {{host}}/api/invites/resolve?token={{inviteToken}}
Authorization: Bearer {{access_token}}

> {%
  client.test("Invites /resolve — authenticated resolve 200 (best-effort if token present)", function () {
    const token = String(client.global.get("inviteToken") || "");
    if (!token) {
      client.assert(true, "skipped: inviteToken is not available from create response");
      return;
    }

    client.assert(response.status === 200, "expected 200, got " + response.status);

    const b = response.body || {};
    client.assert(!!b.state, "missing state in response");

    client.assert(
        /AUTHENTICATED_CAN_ACCEPT|AUTHENTICATED_ALREADY_MEMBER|AUTHENTICATED_EMAIL_MISMATCH/i.test(String(b.state)),
        "unexpected authenticated resolve state: " + String(b.state)
    );
  });
%}

### 1.7 ACCEPT (POSITIVE/NEGATIVE): if token is known — accept invite
POST {{host}}/api/invites/accept
Content-Type: application/json
Authorization: Bearer {{access_token}}

{
  "token": "{{inviteToken}}"
}

> {%
  client.test("Invites /accept — 200/4xx (best-effort if token present)", function () {
    const token = String(client.global.get("inviteToken") || "");
    if (!token) {
      client.assert(true, "skipped: inviteToken is not available from create response");
      return;
    }

    client.assert([200, 400, 409].indexOf(response.status) >= 0, "unexpected status: " + response.status);

    const b = response.body || {};
    if (response.status === 200) {
      const hasAnySignal =
          (b && (b.accepted !== undefined)) ||
          (b && (b.grantedAccountIds !== undefined)) ||
          (b && (b.status !== undefined));
      client.assert(hasAnySignal, "accept response has no recognizable fields; adjust contract checks");
    }
  });
%}

### =========================================================
### CLEANUP — delete created resources
### =========================================================

### 2.1 CLEANUP — DELETE connection OZON (Account B) (optional)
DELETE {{host}}/api/accounts/{{accountIdInviteB}}/connections/{{connectionIdInviteB_Ozon}}
Authorization: Bearer {{access_token}}

> {%
  client.test("Cleanup — delete InviteB OZON 204 (optional)", function () {
    const id = String(client.global.get("connectionIdInviteB_Ozon") || "");
    if (!id) {
      client.assert(true, "skipped: connectionIdInviteB_Ozon not created");
      return;
    }
    client.assert(response.status === 204, "expected 204, got " + response.status);
  });
%}

### 2.2 CLEANUP — DELETE connection WB (Account A) (optional)
DELETE {{host}}/api/accounts/{{accountIdInviteA}}/connections/{{connectionIdInviteA_Wb}}
Authorization: Bearer {{access_token}}

> {%
  client.test("Cleanup — delete InviteA WB 204 (optional)", function () {
    const id = String(client.global.get("connectionIdInviteA_Wb") || "");
    if (!id) {
      client.assert(true, "skipped: connectionIdInviteA_Wb not created");
      return;
    }
    client.assert(response.status === 204, "expected 204, got " + response.status);
  });
%}

### 2.3 CLEANUP — DELETE Account A (204)
DELETE {{host}}/api/accounts/{{accountIdInviteA}}
Authorization: Bearer {{access_token}}

> {%
  client.test("Cleanup — delete Invite Account A 204", function () {
    client.assert(response.status === 204, "expected 204, got " + response.status);
  });
%}

### 2.4 CLEANUP — DELETE Account B (204)
DELETE {{host}}/api/accounts/{{accountIdInviteB}}
Authorization: Bearer {{access_token}}

> {%
  client.test("Cleanup — delete Invite Account B 204", function () {
    client.assert(response.status === 204, "expected 204, got " + response.status);
  });
%}
