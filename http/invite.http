### =========================================================
### AUTH — Keycloak password grant (access_token)
### =========================================================
POST {{keycloakBaseUrl}}/realms/{{keycloakRealm}}/protocol/openid-connect/token
Content-Type: application/x-www-form-urlencoded

grant_type=password&client_id={{keycloakClientId}}&client_secret={{keycloakClientSecret}}&username={{keycloakUsername}}&password={{keycloakPassword}}

> {%
  client.test("Auth — got access_token", function () {
    client.assert(response.status === 200, "expected 200, got " + response.status);

    const b = response.body || {};
    client.assert(!!b.access_token, "missing access_token in response");

    client.global.set("access_token", b.access_token);
  });
%}

### =========================================================
### PREPARE — create account (invite target)
### =========================================================

### 0.1 ACCOUNT — CREATE (201)
POST {{host}}/api/accounts
Content-Type: application/json
Authorization: Bearer {{access_token}}

{
  "name": "Test Account — Invites"
}

> {%
  client.test("Prepare /api/accounts — create 201", function () {
    client.assert(response.status === 201, "expected 201, got " + response.status);

    const b = response.body || {};
    client.assert(b.id !== undefined, "missing id in response");
    client.global.set("accountIdInvites", String(b.id || ""));
  });
%}

### =========================================================
### TESTS — AccountInviteController /api/invites
### =========================================================

### 1.0 CREATE (NEGATIVE): email invalid -> 400 (validation)
POST {{host}}/api/invites
Content-Type: application/json
Authorization: Bearer {{access_token}}

{
  "email": "not-an-email",
  "initialRole": "VIEWER",
  "accountIds": [{{accountIdInvites}}]
}

> {%
  client.test("Invites /create — invalid email 400", function () {
    client.assert(response.status === 400, "expected 400, got " + response.status);

    const b = response.body || {};
    const msg = (b && b.message) || (b && b.error) || JSON.stringify(b);
    client.assert(/email|почт|INVITE_EMAIL/i.test(msg), "unexpected validation response: " + msg);
  });
%}

### 1.1 CREATE (NEGATIVE): accountIds empty -> 400 (validation)
POST {{host}}/api/invites
Content-Type: application/json
Authorization: Bearer {{access_token}}

{
  "email": "invitee@example.com",
  "initialRole": "VIEWER",
  "accountIds": []
}

> {%
  client.test("Invites /create — accountIds empty 400", function () {
    client.assert(response.status === 400, "expected 400, got " + response.status);

    const b = response.body || {};
    const msg = (b && b.message) || (b && b.error) || JSON.stringify(b);
    client.assert(/accountIds|accounts|required|INVITE_ACCOUNTS/i.test(msg), "unexpected validation response: " + msg);
  });
%}

### 1.2 CREATE (NEGATIVE): token missing on accept -> 400 (validation)
POST {{host}}/api/invites/accept
Content-Type: application/json
Authorization: Bearer {{access_token}}

{
  "token": ""
}

> {%
  client.test("Invites /accept — empty token 400", function () {
    client.assert(response.status === 400, "expected 400, got " + response.status);

    const b = response.body || {};
    const msg = (b && b.message) || (b && b.error) || JSON.stringify(b);
    client.assert(/token|required|INVITE_TOKEN/i.test(msg), "unexpected validation response: " + msg);
  });
%}

### 1.3 RESOLVE (NEGATIVE): invalid token -> 200 with state INVALID/EXPIRED/CANCELLED/etc
GET {{host}}/api/invites/resolve?token=invalid-token-value

> {%
  client.test("Invites /resolve — invalid token -> state != PENDING", function () {
    client.assert(response.status === 200, "expected 200, got " + response.status);

    const b = response.body || {};
    client.assert(!!b.state, "missing state in response");

    // допустимые негативные состояния
    client.assert(
        /INVALID|EXPIRED|CANCELLED|ALREADY_ACCEPTED|ANONYMOUS_NEED_AUTH|AUTHENTICATED_EMAIL_MISMATCH|AUTHENTICATED_ALREADY_MEMBER/i.test(String(b.state)),
        "unexpected state for invalid token: " + String(b.state)
    );
  });
%}

### 1.4 CREATE (POSITIVE): create invite -> 201, store token (best-effort)
POST {{host}}/api/invites
Content-Type: application/json
Authorization: Bearer {{access_token}}

{
  "email": "vitaliikim992@gmail.com",
  "initialRole": "VIEWER",
  "accountIds": [10,11]
}

> {%
  client.test("Invites /create — 201 + token", function () {
    client.assert(response.status === 201, "expected 201, got " + response.status);

    const b = response.body || {};
    // Мы не знаем точный контракт AccountInviteResponse — поэтому проверяем "что-то" похожее на токен.
    // Если у вас поле называется иначе — поправь здесь на b.token / b.inviteToken / b.id и т.п.
    const token =
        (b && b.token) ||
        (b && b.inviteToken) ||
        (b && b.invite && b.invite.token) ||
        null;

    client.assert(!!token, "missing token field in create response; adjust mapping in test");
    client.global.set("inviteToken", String(token));
  });
%}

### 1.5 RESOLVE (POSITIVE): resolve token as anonymous (no Authorization) -> state might be ANONYMOUS_NEED_AUTH or PENDING
GET {{host}}/api/invites/resolve?token={{inviteToken}}

> {%
  client.test("Invites /resolve — anonymous resolve 200 + state", function () {
    client.assert(response.status === 200, "expected 200, got " + response.status);

    const b = response.body || {};
    client.assert(!!b.state, "missing state in response");

    // В зависимости от бизнес-логики, при отсутствии аутентификации:
    // - либо PENDING (и показываем детали),
    // - либо ANONYMOUS_NEED_AUTH (и просим залогиниться).
    client.assert(
        /PENDING|ANONYMOUS_NEED_AUTH/i.test(String(b.state)),
        "unexpected anonymous resolve state: " + String(b.state)
    );
  });
%}

### 1.6 RESOLVE (POSITIVE): resolve token as authenticated user -> state should be AUTHENTICATED_CAN_ACCEPT or AUTHENTICATED_ALREADY_MEMBER / AUTHENTICATED_EMAIL_MISMATCH
GET {{host}}/api/invites/resolve?token={{inviteToken}}
Authorization: Bearer {{access_token}}

> {%
  client.test("Invites /resolve — authenticated resolve 200 + state", function () {
    client.assert(response.status === 200, "expected 200, got " + response.status);

    const b = response.body || {};
    client.assert(!!b.state, "missing state in response");

    client.assert(
        /AUTHENTICATED_CAN_ACCEPT|AUTHENTICATED_ALREADY_MEMBER|AUTHENTICATED_EMAIL_MISMATCH/i.test(String(b.state)),
        "unexpected authenticated resolve state: " + String(b.state)
    );
  });
%}

### 1.7 ACCEPT (POSITIVE/NEGATIVE depends): accept invite as authenticated user -> 200 (best-effort contract check)
POST {{host}}/api/invites/accept
Content-Type: application/json
Authorization: Bearer {{access_token}}

{
  "token": "{{inviteToken}}"
}

> {%
  client.test("Invites /accept — 200 (or business 4xx), contract check", function () {
    // В твоём контроллере не задан @ResponseStatus, значит ожидаем 200 при успехе.
    // Но бизнес-логика может возвращать 400/409, например если email mismatch или already accepted.
    client.assert([200, 400, 409].indexOf(response.status) >= 0, "unexpected status: " + response.status);

    const b = response.body || {};
    // Если успех — ожидаем какой-то признак результата (не знаем точный контракт)
    if (response.status === 200) {
      const hasAnySignal =
          (b && (b.status !== undefined)) ||
          (b && (b.accepted !== undefined)) ||
          (b && (b.memberId !== undefined)) ||
          (b && (b.accountIds !== undefined));

      client.assert(hasAnySignal, "accept response has no recognizable fields; adjust contract checks");
    }
  });
%}

### 1.8 ACCEPT (NEGATIVE): accept same token second time -> should NOT be 200; expect 200 with state change or 4xx
POST {{host}}/api/invites/accept
Content-Type: application/json
Authorization: Bearer {{access_token}}

{
  "token": "{{inviteToken}}"
}

> {%
  client.test("Invites /accept — second accept should fail or be idempotent (non-200 preferred)", function () {
    // Если вы делаете идемпотентность (200 OK повторно) — можно расширить, но по умолчанию ожидаем 4xx.
    client.assert([400, 409].indexOf(response.status) >= 0 || response.status === 200, "unexpected status: " + response.status);
  });
%}

### =========================================================
### CLEANUP — delete account (cascade clears membership)
### =========================================================

### 2.1 DELETE ACCOUNT (204)
DELETE {{host}}/api/accounts/{{accountIdInvites}}
Authorization: Bearer {{access_token}}

> {%
  client.test("Cleanup — delete account 204", function () {
    client.assert(response.status === 204, "expected 204, got " + response.status);
  });
%}
