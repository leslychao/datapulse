<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog
  xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
  xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
  xsi:schemaLocation="
        http://www.liquibase.org/xml/ns/dbchangelog
        https://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.4.xsd">

  <changeSet id="0008-create-catalog-item" author="vitalii.kim" dbms="postgresql">

    <sql>
      CREATE EXTENSION IF NOT EXISTS pg_trgm;
      CREATE TABLE IF NOT EXISTS catalog_item
      (
        id               BIGSERIAL PRIMARY KEY,

        account_id       BIGINT      NOT NULL,
        marketplace      VARCHAR(32) NOT NULL,

        title            VARCHAR(512),         -- как мы видим товар в UI
        brand            VARCHAR(256),         -- бренд

        mp_item_id       VARCHAR(64) NOT NULL, -- Ozon: sku, WB: nmId
        mp_offer_id      VARCHAR(64),          -- Ozon: offer_id, WB: supplierArticle
        mp_barcode       VARCHAR(128),

        mp_category      VARCHAR(256),         -- «категория» от МП
        mp_subject       VARCHAR(256),         -- subject / подкатегория

        mp_is_kgt        BOOLEAN,
        mp_is_archived   BOOLEAN     NOT NULL DEFAULT FALSE,

        mp_price_regular NUMERIC(19, 2),
        mp_price_sale    NUMERIC(19, 2),
        mp_vat_rate      NUMERIC(4, 2),

        last_synced_at   TIMESTAMPTZ,

        CONSTRAINT uq_catalog_item_acc_mp_item
          UNIQUE (account_id, marketplace, mp_item_id)
      );

      CREATE INDEX idx_catalog_item_mp_offer
        ON catalog_item (account_id, marketplace, mp_offer_id);

      CREATE INDEX idx_catalog_item_barcode
        ON catalog_item (mp_barcode);

      CREATE INDEX idx_catalog_item_brand
        ON catalog_item (brand);

      CREATE INDEX idx_catalog_item_title_trgm
        ON catalog_item USING gin (title gin_trgm_ops);
    </sql>

    <rollback>
      DROP TABLE IF EXISTS catalog_item;
    </rollback>

  </changeSet>

</databaseChangeLog>
