<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog
  xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
  xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
  xsi:schemaLocation="
        http://www.liquibase.org/xml/ns/dbchangelog
        https://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.4.xsd">

  <changeSet id="0008-create-sales-fact-materialization-fn" author="vitalii.kim" dbms="postgresql">

    <sql splitStatements="false" stripComments="false"><![CDATA[
      -- ===========================================
      -- FIX: aggregate src by business key to avoid
      -- "ON CONFLICT DO UPDATE ... cannot affect row a second time"
      -- ===========================================
      CREATE OR REPLACE PROCEDURE materialize_sales_fact(
        IN p_account_id   BIGINT,
        IN p_date_from    DATE,
        IN p_date_to      DATE
      )
        LANGUAGE plpgsql
      AS
      $$
      BEGIN
        -- 1. Удаляем старые факты за диапазон по аккаунту (все маркетплейсы)
        DELETE FROM sales_fact sf
        WHERE sf.account_id = p_account_id
          AND sf.operation_date BETWEEN p_date_from AND p_date_to;

        -- 2. Перезаписываем факты из сырых таблиц с агрегацией по бизнес-ключу
        INSERT INTO sales_fact (
          account_id,
          marketplace,
          operation_date,
          operation_datetime,
          offer_id,
          barcode,
          size,
          warehouse_name,
          region_name,
          quantity,
          gross_amount,
          commission_amount,
          logistics_and_fees_amount,
          promo_amount,
          net_amount,
          operation_type,
          external_operation_id,
          currency_code
        )
        SELECT
          account_id,
          marketplace,
          operation_date,
          MAX(operation_datetime)                             AS operation_datetime,
          offer_id,
          MAX(barcode)                                       AS barcode,
          MAX(size)                                          AS size,
          MAX(warehouse_name)                                AS warehouse_name,
          MAX(region_name)                                   AS region_name,
          COALESCE(SUM(quantity), 0)                         AS quantity,
          COALESCE(SUM(gross_amount), 0::NUMERIC(19, 2))     AS gross_amount,
          COALESCE(SUM(commission_amount), 0::NUMERIC(19, 2)) AS commission_amount,
          COALESCE(SUM(logistics_and_fees_amount), 0::NUMERIC(19, 2))
                                                              AS logistics_and_fees_amount,
          COALESCE(SUM(promo_amount), 0::NUMERIC(19, 2))     AS promo_amount,
          COALESCE(SUM(net_amount), 0::NUMERIC(19, 2))       AS net_amount,
          MAX(operation_type)                                AS operation_type,
          MAX(external_operation_id)                         AS external_operation_id,
          MAX(currency_code)                                 AS currency_code
        FROM (
               ------------------------------------------------------------
               -- 2.1 OZON: raw_sales_fact_ozon (analytics)
               ------------------------------------------------------------
               SELECT
                 r.account_id                                      AS account_id,
                 'OZON'                                            AS marketplace,
                 (dim.day)::DATE                                   AS operation_date,
                 (dim.day || 'T00:00:00Z')::TIMESTAMPTZ           AS operation_datetime,
                 dim.offer_id                                      AS offer_id,
                 (pi.payload->'barcodes'->>0)                      AS barcode,
                 NULL::VARCHAR                                     AS size,
                 dim.warehouse_id                                  AS warehouse_name,
                 NULL::VARCHAR                                     AS region_name,
                 met.ordered_units                                 AS quantity,
                 met.revenue                                       AS gross_amount,
                 met.commission                                    AS commission_amount,
                 met.delivery_amount                               AS logistics_and_fees_amount,
                 0::NUMERIC(19, 2)                                 AS promo_amount,
                 (met.revenue - met.commission - met.delivery_amount)
                                                                   AS net_amount,
                 'SALE'                                            AS operation_type,
                 NULL::VARCHAR                                     AS external_operation_id,
                 COALESCE(pi.payload->>'currency_code', 'RUB')     AS currency_code
               FROM raw_sales_fact_ozon r
                      CROSS JOIN LATERAL (
                 SELECT
                   (SELECT d->>'value'
                    FROM jsonb_array_elements(r.payload->'dimensions') d
                    WHERE d->>'id' = 'sku')          AS sku,
                   (SELECT d->>'value'
                    FROM jsonb_array_elements(r.payload->'dimensions') d
                    WHERE d->>'id' = 'offer_id')     AS offer_id,
                   (SELECT d->>'value'
                    FROM jsonb_array_elements(r.payload->'dimensions') d
                    WHERE d->>'id' = 'warehouse_id') AS warehouse_id,
                   (SELECT d->>'value'
                    FROM jsonb_array_elements(r.payload->'dimensions') d
                    WHERE d->>'id' = 'day')          AS day
                 ) dim
                      CROSS JOIN LATERAL (
                 SELECT
                   COALESCE(
                     (SELECT (m->>'value')::INT
                      FROM jsonb_array_elements(r.payload->'metrics') m
                      WHERE m->>'id' = 'ordered_units'),
                     0
                     )                                              AS ordered_units,
                   COALESCE(
                     (SELECT (m->>'value')::NUMERIC
                      FROM jsonb_array_elements(r.payload->'metrics') m
                      WHERE m->>'id' = 'revenue'),
                     0::NUMERIC
                     )                                              AS revenue,
                   COALESCE(
                     (SELECT (m->>'value')::NUMERIC
                      FROM jsonb_array_elements(r.payload->'metrics') m
                      WHERE m->>'id' = 'commission'),
                     0::NUMERIC
                     )                                              AS commission,
                   COALESCE(
                     (SELECT (m->>'value')::NUMERIC
                      FROM jsonb_array_elements(r.payload->'metrics') m
                      WHERE m->>'id' = 'delivery_amount'),
                     0::NUMERIC
                     )                                              AS delivery_amount
                 ) met
                      LEFT JOIN raw_product_info_ozon pi
                                ON pi.account_id = r.account_id
                                  AND pi.payload->>'offer_id' = dim.offer_id
               WHERE r.account_id = p_account_id
                 AND r.marketplace = 'OZON'
                 AND (dim.day)::DATE BETWEEN p_date_from AND p_date_to

               UNION ALL

               ------------------------------------------------------------
               -- 2.2 OZON: raw_product_info_ozon (product enrichment)
               ------------------------------------------------------------
               SELECT
                 r.account_id                                      AS account_id,
                 'OZON'                                            AS marketplace,
                 (r.payload->>'updated_at')::DATE                  AS operation_date,
                 (r.payload->>'updated_at')::TIMESTAMPTZ           AS operation_datetime,
                 r.payload->>'offer_id'                            AS offer_id,
                 (r.payload->'barcodes'->>0)                       AS barcode,
                 NULL::VARCHAR                                     AS size,
                 NULL::VARCHAR                                     AS warehouse_name,
                 NULL::VARCHAR                                     AS region_name,
                 0                                                 AS quantity,
                 (r.payload->>'price')::NUMERIC                    AS gross_amount,
                 NULL::NUMERIC(19, 2)                              AS commission_amount,
                 NULL::NUMERIC(19, 2)                              AS logistics_and_fees_amount,
                 NULL::NUMERIC(19, 2)                              AS promo_amount,
                 (r.payload->>'price')::NUMERIC                    AS net_amount,
                 'ENRICHMENT'                                      AS operation_type,
                 NULL::VARCHAR                                     AS external_operation_id,
                 r.payload->>'currency_code'                       AS currency_code
               FROM raw_product_info_ozon r
               WHERE r.account_id = p_account_id
                 AND r.marketplace = 'OZON'
                 AND (r.payload->>'updated_at')::DATE BETWEEN p_date_from AND p_date_to

               UNION ALL

               ------------------------------------------------------------
               -- 2.3 WB: raw_realization_fact_wb (realizations)
               ------------------------------------------------------------
               SELECT
                 r.account_id                                      AS account_id,
                 'WILDBERRIES'                                    AS marketplace,
                 (r.payload->>'date')::DATE                       AS operation_date,
                 (r.payload->>'date')::TIMESTAMPTZ                AS operation_datetime,
                 r.payload->>'supplierArticle'                    AS offer_id,
                 r.payload->>'barcode'                            AS barcode,
                 r.payload->>'techSize'                           AS size,
                 r.payload->>'warehouseName'                      AS warehouse_name,
                 r.payload->>'regionName'                         AS region_name,
                 1                                                AS quantity,
                 (r.payload->>'totalPrice')::NUMERIC              AS gross_amount,
                 NULL::NUMERIC(19, 2)                             AS commission_amount,
                 NULL::NUMERIC(19, 2)                             AS logistics_and_fees_amount,
                 (r.payload->>'discountPercent')::NUMERIC         AS promo_amount,
                 (r.payload->>'finishedPrice')::NUMERIC           AS net_amount,
                 'SALE'                                           AS operation_type,
                 r.payload->>'saleID'                             AS external_operation_id,
                 'RUB'                                            AS currency_code
               FROM raw_realization_fact_wb r
               WHERE r.account_id = p_account_id
                 AND r.marketplace IN ('WILDBERRIES', 'WB')
                 AND (r.payload->>'date')::DATE BETWEEN p_date_from AND p_date_to
             ) AS src
        GROUP BY
          account_id,
          marketplace,
          operation_date,
          offer_id
        ON CONFLICT (account_id, marketplace, operation_date, offer_id)
          DO UPDATE SET
                      barcode                   = EXCLUDED.barcode,
                      size                      = EXCLUDED.size,
                      warehouse_name            = EXCLUDED.warehouse_name,
                      region_name               = EXCLUDED.region_name,
                      quantity                  = EXCLUDED.quantity,
                      gross_amount              = EXCLUDED.gross_amount,
                      commission_amount         = EXCLUDED.commission_amount,
                      logistics_and_fees_amount = EXCLUDED.logistics_and_fees_amount,
                      promo_amount              = EXCLUDED.promo_amount,
                      net_amount                = EXCLUDED.net_amount,
                      operation_type            = EXCLUDED.operation_type,
                      external_operation_id     = EXCLUDED.external_operation_id,
                      currency_code             = EXCLUDED.currency_code;
      END;
      $$;
      ]]></sql>

    <rollback>
      <sql splitStatements="false" stripComments="false"><![CDATA[
        DROP PROCEDURE IF EXISTS materialize_sales_fact(BIGINT, DATE, DATE);
      ]]></sql>
    </rollback>

  </changeSet>

</databaseChangeLog>
