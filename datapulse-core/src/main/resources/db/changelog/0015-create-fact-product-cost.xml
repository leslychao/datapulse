<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog
  xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
  xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
  xsi:schemaLocation="
        http://www.liquibase.org/xml/ns/dbchangelog
        https://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.4.xsd">

  <changeSet id="0015-create-fact-product-cost" author="vitalii.kim" dbms="postgresql">
    <sql>
      create table if not exists fact_product_cost
      (
        id         bigserial primary key,

        account_id bigint         not null references account (id),
        product_id bigint         not null references dim_product (id),

        cost_value numeric(18, 6) not null,
        currency   text           not null default 'RUB',

        valid_from date           not null,
        valid_to   date,

        created_at timestamptz    not null default now(),
        updated_at timestamptz    not null default now(),

        constraint chk_fpc_cost_positive
          check (cost_value &gt;= 0),

        constraint chk_fpc_valid_range
          check (valid_to is null or valid_to &gt;= valid_from),

        constraint uq_fpc_scd2
          unique (account_id, product_id, valid_from)
      );

      -- Индекс под джойн "по периоду" (ускоряет between)
      create index if not exists idx_fpc_account_product_period
        on fact_product_cost (account_id, product_id, valid_from, valid_to);

      -- Индекс на текущие значения (активная цена)
      create index if not exists idx_fpc_current
        on fact_product_cost (account_id, product_id)
        where valid_to is null;
    </sql>

    <rollback>
      drop index if exists idx_fpc_current;
      drop index if exists idx_fpc_account_product_period;
      drop table if exists fact_product_cost cascade;
    </rollback>
  </changeSet>

</databaseChangeLog>
