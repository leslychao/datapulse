<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog
  xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
  xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
  xsi:schemaLocation="
        http://www.liquibase.org/xml/ns/dbchangelog
        https://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.4.xsd">

  <changeSet id="0014-create-fact-commission" author="vitalii.kim" dbms="postgresql">
    <sql>
      CREATE TABLE IF NOT EXISTS fact_commission
      (
        id              BIGSERIAL PRIMARY KEY,
        account_id      BIGINT         NOT NULL,
        source_platform TEXT           NOT NULL,
        order_id        TEXT           NULL,
        operation_date  DATE           NOT NULL,
        commission_type TEXT           NOT NULL,
        amount          NUMERIC(18, 4) NOT NULL,
        currency        TEXT           NOT NULL,
        amount_raw      NUMERIC(18, 4) NOT NULL,
        amount_abs      NUMERIC(18, 4) NOT NULL,
        commission_kind TEXT           NOT NULL,
        created_at      TIMESTAMPTZ    NOT NULL DEFAULT now(),
        updated_at      TIMESTAMPTZ    NOT NULL DEFAULT now(),
        CONSTRAINT uq_fact_commission_source
          UNIQUE (account_id, source_platform, operation_date, order_id, commission_type)
      );

      CREATE INDEX IF NOT EXISTS idx_fact_commission_account_date
        ON fact_commission (account_id, operation_date);

      CREATE INDEX IF NOT EXISTS idx_fact_commission_order
        ON fact_commission (account_id, source_platform, order_id);
    </sql>

    <rollback>
      DROP TABLE IF EXISTS fact_commission CASCADE;
    </rollback>
  </changeSet>

</databaseChangeLog>
