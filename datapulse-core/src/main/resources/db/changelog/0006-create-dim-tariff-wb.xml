<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog
  xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
  xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
  xsi:schemaLocation="
        http://www.liquibase.org/xml/ns/dbchangelog
        https://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.4.xsd">

  <changeSet id="0006-create-dim-tariff-wb" author="vitalii.kim" dbms="postgresql">
    <sql>
      create table if not exists dim_tariff_wb
      (
        id                    bigserial primary key,

        source_platform       text           not null,
        dim_category_id       bigint         not null references dim_category (id),

        kgvp_booking          numeric(10, 4) not null,
        kgvp_marketplace      numeric(10, 4) not null,
        kgvp_pickup           numeric(10, 4) not null,
        kgvp_supplier         numeric(10, 4) not null,
        kgvp_supplier_express numeric(10, 4) not null,
        paid_storage_kgvp     numeric(10, 4) not null,

        valid_from            date           not null,
        valid_to              date,

        created_at            timestamptz    not null default now(),
        updated_at            timestamptz    not null default now(),

        constraint uq_dim_tariff_wb_scd2
          unique (source_platform, dim_category_id, valid_from)
      );

      create index if not exists idx_dim_tariff_wb_current
        on dim_tariff_wb (source_platform, dim_category_id)
        where valid_to is null;
    </sql>

    <rollback>
      drop index if exists idx_dim_tariff_wb_current;
      drop table if exists dim_tariff_wb cascade;
    </rollback>
  </changeSet>

</databaseChangeLog>
