<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog
  xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
  xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
  xsi:schemaLocation="
        http://www.liquibase.org/xml/ns/dbchangelog
        https://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.4.xsd">

  <!-- =============================================================== -->
  <!-- FACT LOGISTICS COSTS — логистические затраты по заказам        -->
  <!-- grain: account + platform + order + logistics_type + op_date   -->
  <!-- =============================================================== -->

  <changeSet id="0013-create-fact-logistics-costs" author="vitalii.kim" dbms="postgresql">

    <sql>
      create table if not exists fact_logistics_costs
      (
        id                      bigserial primary key,

        account_id              bigint         not null,
        source_platform         text           not null,
        source_event_id         text           not null,

        order_id                text,
        warehouse_id            bigint,

        operation_date          date           not null,
        logistics_type          text           not null,

        logistics_charge_amount numeric(18, 2) not null,
        logistics_refund_amount numeric(18, 2) not null,
        currency                text           not null,

        created_at              timestamptz    not null default now(),
        updated_at              timestamptz    not null default now(),

        constraint uq_fact_logistics_costs_source
          unique (account_id, source_platform, source_event_id)
      );
    </sql>

    <sql>
      create index if not exists idx_fact_logistics_costs_order
        on fact_logistics_costs (account_id, source_platform, order_id);

      create index if not exists idx_fact_logistics_costs_date
        on fact_logistics_costs (operation_date);
    </sql>

  </changeSet>

</databaseChangeLog>
