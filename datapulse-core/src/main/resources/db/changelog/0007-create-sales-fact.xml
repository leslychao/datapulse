<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog
  xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
  xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
  xsi:schemaLocation="
        http://www.liquibase.org/xml/ns/dbchangelog
        https://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.4.xsd">

  <changeSet id="0007-create-sales-fact" author="vitalii.kim" dbms="postgresql">

    <sql>
      CREATE TABLE IF NOT EXISTS sales_fact
      (
        id                   BIGSERIAL PRIMARY KEY,

        account_id           BIGINT        NOT NULL,
        marketplace          VARCHAR(32)   NOT NULL,

        sale_date            DATE          NOT NULL,
        catalog_item_id      BIGINT        NOT NULL,
        warehouse_id         BIGINT            NULL,

        ordered_units        INTEGER       NOT NULL DEFAULT 0,
        delivered_units      INTEGER       NOT NULL DEFAULT 0,
        returned_units       INTEGER       NOT NULL DEFAULT 0,
        canceled_units       INTEGER       NOT NULL DEFAULT 0,

        gmv_amount           NUMERIC(19,2) NOT NULL DEFAULT 0,

        currency_code        CHAR(3)       NOT NULL DEFAULT 'RUB',

        created_at           TIMESTAMPTZ   NOT NULL DEFAULT now(),
        updated_at           TIMESTAMPTZ   NOT NULL DEFAULT now(),

        UNIQUE (account_id, marketplace, sale_date, catalog_item_id, warehouse_id)
      );

      CREATE INDEX IF NOT EXISTS idx_sales_fact_account_date
        ON sales_fact (account_id, sale_date);

      CREATE INDEX IF NOT EXISTS idx_sales_fact_item
        ON sales_fact (catalog_item_id);

      CREATE INDEX IF NOT EXISTS idx_sales_fact_warehouse
        ON sales_fact (warehouse_id);
    </sql>

    <rollback>
      DROP TABLE IF EXISTS sales_fact;
    </rollback>

  </changeSet>

</databaseChangeLog>
