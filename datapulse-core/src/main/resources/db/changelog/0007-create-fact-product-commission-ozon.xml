<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog
  xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
  xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
  xsi:schemaLocation="
        http://www.liquibase.org/xml/ns/dbchangelog
        https://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.4.xsd">

  <changeSet id="0007-create-fact-product-commission-ozon" author="vitalii.kim" dbms="postgresql">
    <sql>
      CREATE TABLE IF NOT EXISTS fact_product_commission_ozon
      (
        id                           BIGSERIAL PRIMARY KEY,

        account_id                   BIGINT         NOT NULL,
        product_id                   BIGINT         NOT NULL,
        offer_id                     TEXT           NOT NULL,

        fulfillment_schema           TEXT           NOT NULL, -- FBO / FBS / RFBS / FBP
        snapshot_date                DATE           NOT NULL,

        sales_percent                NUMERIC(9, 4)  NOT NULL,

        deliv_to_customer_amount     NUMERIC(12, 4) NULL,
        direct_flow_trans_min_amount NUMERIC(12, 4) NULL,
        direct_flow_trans_max_amount NUMERIC(12, 4) NULL,
        first_mile_min_amount        NUMERIC(12, 4) NULL,
        first_mile_max_amount        NUMERIC(12, 4) NULL,
        return_flow_amount           NUMERIC(12, 4) NULL,

        volume_weight                NUMERIC(12, 4) NULL,

        created_at                   TIMESTAMPTZ    NOT NULL DEFAULT now(),

        CONSTRAINT uq_fact_product_commission_ozon
          UNIQUE (account_id, product_id, offer_id, fulfillment_schema, snapshot_date)
      );

      CREATE INDEX IF NOT EXISTS idx_fact_commission_ozon_product
        ON fact_product_commission_ozon (account_id, product_id);

      CREATE INDEX IF NOT EXISTS idx_fact_commission_ozon_snapshot
        ON fact_product_commission_ozon (snapshot_date);
    </sql>

    <rollback>
      DROP TABLE IF EXISTS fact_product_commission_ozon CASCADE;
    </rollback>
  </changeSet>

</databaseChangeLog>
