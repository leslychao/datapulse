<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog
  xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
  xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
  xsi:schemaLocation="
        http://www.liquibase.org/xml/ns/dbchangelog
        https://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.4.xsd">

  <!-- =============================================================== -->
  <!-- FACT FINANCE — P&L по заказу                                   -->
  <!-- grain: account + platform + order + finance_date               -->
  <!-- =============================================================== -->

  <changeSet id="0014-create-fact-finance" author="vitalii.kim" dbms="postgresql">

    <sql>
      create table if not exists fact_finance
      (
        id                            bigserial primary key,

        account_id                    bigint         not null,
        source_platform               text           not null,
        order_id                      text           not null,
        finance_date                  date           not null,

        currency                      text           not null default 'RUB',

        revenue_gross                 numeric(18, 2) not null default 0,
        seller_discount_amount        numeric(18, 2) not null default 0,
        marketplace_commission_amount numeric(18, 2) not null default 0,
        logistics_cost_amount         numeric(18, 2) not null default 0,
        penalties_amount              numeric(18, 2) not null default 0,
        marketing_cost_amount         numeric(18, 2) not null default 0,
        compensation_amount           numeric(18, 2) not null default 0,
        refund_amount                 numeric(18, 2) not null default 0,
        net_payout                    numeric(18, 2) not null default 0,

        created_at                    timestamptz    not null default now(),
        updated_at                    timestamptz    not null default now()
      );

      create unique index if not exists ux_fact_finance_order
        on fact_finance (account_id, source_platform, order_id, finance_date);

      create index if not exists ix_fact_finance_account_platform_date
        on fact_finance (account_id, source_platform, finance_date);

      create index if not exists ix_fact_finance_order_id
        on fact_finance (order_id);
    </sql>

    <rollback>
      drop table if exists fact_finance cascade;
    </rollback>
  </changeSet>

</databaseChangeLog>
